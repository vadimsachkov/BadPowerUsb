BadPowerUsb - Инструмент мониторинга USB-устройств и условного выполнения команд
Версия: 1.3

Описание:
BadPowerUsb - это консольное приложение для Windows, которое отслеживает подключение
заданного USB-устройства к системе по его идентификатору экземпляра (Device Instance Path).
Если устройство отсутствует дольше заданного времени, а время работы системы превышает
минимальный порог, программа выполняет указанную команду (например, выключение системы).

Время последнего успешного обнаружения устройства сохраняется в файле BadPowerUsb_last_success.txt.
Логи записываются в файл формата BadPowerUsb_ГГГГММ.log (например, BadPowerUsb_202503.log),
старые логи автоматически удаляются через год.

Требования:
- Программа требует стандарт C++17. Убедитесь, что в настройках проекта (Debug и Release)
  установлен стандарт ISO C++17 (/std:c++17):
  Свойства проекта → C/C++ → Язык → Стандарт языка C++ → ISO C++17.

Функциональность:
1. Проверяет наличие USB-устройства в системе по его идентификатору экземпляра.
2. Если устройство подключено:
   - Обновляет файл BadPowerUsb_last_success.txt с текущим временем.
   - Выводит сообщение в лог и завершает работу.
3. Если устройство отсутствует:
   - Читает время последнего успешного подключения из файла BadPowerUsb_last_success.txt.
   - Сравнивает время отсутствия устройства с параметром -wait_min.
   - Сравнивает время работы системы (uptime) с параметром -uptime_min.
   - Если оба условия выполнены (время отсутствия >= wait_min и uptime >= uptime_min),
     выполняет указанную команду (-exec).
4. Удаляет логи старше 365 дней из указанной директории (-pathlog).
5. Записывает подробные сообщения в лог с указанием всех проверок и результатов.

Параметры командной строки:
Обязательные параметры:
  -uid_usb <идентификатор>    Идентификатор экземпляра USB-устройства (например, USB\VID_1A40&PID_0201\5&2E786FD2&0&9).
                              Можно найти в диспетчере устройств: Свойства устройства → Сведения → Путь к экземпляру устройства.
  -wait_min <минуты>          Максимальное время в минутах, в течение которого устройство может отсутствовать.
  -uptime_min <минуты>        Минимальное время работы системы в минутах для выполнения команды.
  -exec "<команда>"           Команда для выполнения, если условия выполнены (в кавычках).
  -pathlog <путь>             Папка для хранения логов и файла BadPowerUsb_last_success.txt.

Необязательные параметры:
  -? /? ?                     Показать справочную информацию и выйти.

Примеры использования:
1. Простая проверка с запуском notepad:
   BadPowerUsb.exe -uid_usb "USB\VID_1A40&PID_0201\5&2E786FD2&0&9" -wait_min 120 -uptime_min 20 -pathlog "C:\temp" -exec "notepad"
   - Мониторит USB-устройство.
   - Если устройство отсутствует более 120 минут, и система работает более 20 минут, запускает блокнот.

2. Выключение системы с комментарием:
   BadPowerUsb.exe -uid_usb "USB\VID_1A40&PID_0201\5&2E786FD2&0&9" -wait_min 120 -uptime_min 20 -pathlog "C:\temp" -exec "shutdown /s /t 180 /c \"Скрипт BadPowerUsb инициировал выключение системы, так как USB-устройство USB\VID_1A40&PID_0201\5&2E786FD2&0&9 не подключено долгое время, возможно, из-за сбоя питания.\""
   - Если устройство отсутствует более 120 минут и uptime системы больше 20 минут:
     - Система выключится через 180 секунд (3 минуты).
     - В системном журнале (ID 1074) появится указанный комментарий.

3. Вывод справки:
   BadPowerUsb.exe -?
   - Показывает справочную информацию о параметрах.

Формат логов:
Логи записываются в файл BadPowerUsb_ГГГГММ.log в папке, указанной в -pathlog.
Пример вывода, если устройство подключено:
   2025-03-25 16:42:16 - ------------------------------------------------------------
   2025-03-25 16:42:16 - Starting check for USB device: USB\VID_1A40&PID_0201\5&2E786FD2&0&9
   2025-03-25 16:42:16 - Found connected device: USB\VID_1A40&PID_0201\5&2E786FD2&0&9
   2025-03-25 16:42:16 - USB device found. Timestamp updated.

Пример вывода, если устройство отсутствует:
   2025-03-25 16:42:16 - ------------------------------------------------------------
   2025-03-25 16:42:16 - Starting check for USB device: USB\VID_1A40&PID_0201\5&2E786FD2&0&9
   2025-03-25 16:42:16 - Last success timestamp read: 2025-03-25 15:42:16
   2025-03-25 16:42:16 - USB device not found. Time since last success: 60.000000 min, Uptime: 1898 min.
   2025-03-25 16:42:16 - Time since last success (60) < wait_min (120)
   2025-03-25 16:42:16 - System uptime (1898) >= uptime_min (20)
   2025-03-25 16:42:16 - Conditions NOT met. No action taken.

Примечания:
- Для отмены выключения, инициированного shutdown /s, используйте команду: shutdown /a.
  В системном журнале появится событие ID 1075.
- Убедитесь, что папка, указанная в -pathlog, доступна для записи.
- Программа завершает работу после каждого запуска. Для постоянного мониторинга используйте
  планировщик задач Windows (Task Scheduler) с повторением, например, каждые 5 минут.

Автор:
xAI (на основе оригинального кода от пользователя).